import React, { useState, useEffect } from 'react'
import Modal from './Modal'
import { FormSelect, Form, FormInput } from "shards-react";
import FileDropzone from '../components/FileDropzone';
import ReactQuill from 'react-quill';
import apis from '../apis'
import update from 'immutability-helper';
import util from '../util'
import LoginStatus from '../data/singleton/LoginStatus'
import constants from '../constants'
import QuillEditor from '../components/QuillEditor'

const dialogStyle = {
    maxWidth: 800,
    width: 800
};

export default function InnovationAcademyEditor({
    editTarget,
    mode = 'write',
    onSubmitSuccess,
    onCloseRequest
}) {
    const [waiting, setWaiting] = useState(false)
    const [author, setAuthor] = useState(editTarget ?.author || '');
    const [title, setTitle] = useState(editTarget ?.title || '');
    const [contents, setContents] = useState(editTarget ?.contents || '');
    const [attachments, setAttachments] = useState(editTarget ?.attachments || '');
    const [selectedBoardId, setSelectedBoardId] = useState(editTarget ? editTarget.boardId : -1)
    const [boardLabels, setBoardLabels] = useState([])
    const [labels, setLabels] = useState(editTarget ? editTarget.labels : [])
    const [selectedAddingLabelId, setSelectedAddingLabelId] = useState('')

    useEffect(() => {
        setBoardLabels([])
        apis.boardController.getLabels(selectedBoardId).then(response => {
            setBoardLabels(response.data)
            setSelectedAddingLabelId(response.data.length > 0 ? response.data[0].id : '')
        }).catch(error => {
            console.error(error)
            setBoardLabels([])
        })
        return () => { };
    }, [selectedBoardId, setBoardLabels])

    const onSubmit = async () => {
        let attachmentParam = ''
        if (attachments) {
            if (typeof (attachments) === 'string') {
                attachmentParam = attachments
            } else {
                try {
                    attachmentParam = ((await apis.dataController.uploadData('file', attachments)).data.url)

                } catch (error) {
                    alert('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
                }
            }
        }

        const postingInput = {
            "author": author,
            "title": title,
            "thumbnail": '',
            "image": '',
            "summary": '',
            "contents": contents,
            "link": '',
            "attachments": attachmentParam
        }

        if (selectedBoardId < 0) {
            window.alert('Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏßÄÏ†ïÎêòÏñ¥ÏûàÏßÄ ÏïäÏäµÎãàÎã§.')
            return
        }

        if (mode === 'write') {
            try {
                setWaiting(true)
                const response = await apis.boardController.post(selectedBoardId, [postingInput])
                if (labels && labels.length > 0) {
                    for (let label of labels) {
                        await apis.boardController.addLabelToPost(selectedBoardId, response.data[0].id, label.id)
                    }
                }
                if (onSubmitSuccess) {
                    onSubmitSuccess()
                }
            } catch (error) {
                alert(error ?.response ?.data ?.message || 'Í≤åÏãúÎ¨º Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
                setWaiting(false)
            }
        } else {
            try {
                await apis.boardController.put(selectedBoardId, editTarget.id, postingInput)
                if (onSubmitSuccess) {
                    onSubmitSuccess()
                }
            } catch (error) {
                alert(error ?.response ?.data ?.message || 'Í≤åÏãúÎ¨º ÏàòÏ†ïÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.')
            }
        }
    }

    const onDelete = async () => {
        if (!window.confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
            return;
        }
        try {
            await apis.boardController.delete(selectedBoardId, editTarget.id)
            // eslint-disable-next-line no-unused-expressions
            onSubmitSuccess ?.();
        } catch (error) {
            alert(util.getErrorMessage(error));
            return;
        }
    };

    const getFooterActions = () => {
        const result = ["close"]
        if (mode === "write") {
            if (LoginStatus.hasBoardAuthority(selectedBoardId, constants.boardAuthorities.create)) {
                result.push("submit")
            }
        } else {
            if (LoginStatus.hasBoardAuthority(selectedBoardId, constants.boardAuthorities.modify)) {
                result.push("save_changes")
            }
            if (LoginStatus.hasBoardAuthority(selectedBoardId, constants.boardAuthorities.delete)) {
                result.push("delete")
            }
        }
        
        return result;
    }

    return (
        <Modal
            submitEnabled={!waiting}
            onCloseRequest={onCloseRequest}
            footerActions={getFooterActions()}
            onSubmitRequest={onSubmit}
            onSaveChangeRequest={onSubmit}
            onDeleteRequest={onDelete}
            dialogStyle={dialogStyle}
        >
            <Form className="add-new-post">

                {
                    mode === "write" ?
                        <>
                            <b>Ïπ¥ÌÖåÍ≥†Î¶¨</b>
                            <FormSelect size="lg" className="mb-3" placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨" onChange={(e) => {
                                setLabels([]); setSelectedBoardId(parseInt(e.target.value))
                            }} value={selectedBoardId}>
                                <option disabled value={-1}>ÏóÜÏùå</option>
                                {
                                    LoginStatus.hasBoardAuthority(3,
                                        mode === "write" ?
                                            constants.boardAuthorities.create :
                                            constants.boardAuthorities.modify) ?
                                        <option value={3}>Ï†ïÎ≥¥Í≥µÍ∞ú</option> :
                                        undefined}
                                {
                                    LoginStatus.hasBoardAuthority(4,
                                        mode === "write" ?
                                            constants.boardAuthorities.create :
                                            constants.boardAuthorities.modify) ?
                                        <option value={4}>ÏïåÎ¶º</option> :
                                        undefined}
                            </FormSelect>
                        </> : undefined
                }
                {
                    boardLabels && boardLabels.length > 0 &&
                    <div>
                        <b>ÎßêÎ®∏Î¶¨</b><br />
                        {
                            labels.map((item, key) => {
                                return <div key={key} className="badge-container">{item.name}
                                    {
                                        LoginStatus.hasBoardAuthority(selectedBoardId, constants.boardAuthorities.modify) ?
                                            < div
                                                className="delete-btn"
                                                onClick={() => {
                                                    if (mode === "edit") {
                                                        apis.boardController.removeLabelToPost(selectedBoardId, editTarget.id, item.id).then(response => {
                                                            setLabels(update(labels, { $splice: [[key, 1]] }))
                                                        }).catch(error => {
                                                            alert(util.getErrorMessage(error, 'ÎùºÎ≤® ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.'))
                                                        });
                                                    } else {
                                                        const removeIndex = labels.findIndex(label => label.id === item.id);
                                                        if (removeIndex >= 0)
                                                            setLabels(update(labels, { $splice: [[removeIndex, 1]] }))
                                                    }
                                                }}>
                                                ùñ∑
                                        </div>
                                            : undefined
                                    }
                                </div>
                            })
                        }
                        {
                            LoginStatus.hasBoardAuthority(selectedBoardId, constants.boardAuthorities.modify) ?
                                <div className="display-inline-block">
                                    <FormSelect className="mb-1" value={selectedAddingLabelId} onChange={e => setSelectedAddingLabelId(parseInt(e.target.value))} style={{ width: 'auto' }}>
                                        {
                                            boardLabels.map((item, key) => <option key={key} value={item.id}>{item.name}</option>)
                                        }
                                    </FormSelect>
                                    <button type="button" className="btn mb-1 btn-primary" onClick={() => {
                                        if (labels.find(item => item.id === selectedAddingLabelId)) {
                                            alert('Ïù¥ÎØ∏ Ï∂îÍ∞ÄÎêòÏñ¥ÏûàÏäµÎãàÎã§.')
                                        } else {
                                            if (mode === "edit") {
                                                apis.boardController.addLabelToPost(selectedBoardId, editTarget.id, selectedAddingLabelId).then(response => {
                                                    setLabels(update(labels, { $push: [boardLabels.find(label => label.id === selectedAddingLabelId)] }))
                                                }).catch(error => {
                                                    alert(util.getErrorMessage(error, 'ÎùºÎ≤® Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.'))
                                                });
                                            } else {
                                                setLabels(update(labels, { $push: [boardLabels.find(label => label.id === selectedAddingLabelId)] }))
                                            }
                                        }
                                    }}>
                                        Ï∂îÍ∞Ä
                                    </button>
                                </div>
                                : undefined
                        }
                        {mode === "edit" && <p>¬∑ ÎßêÎ®∏Î¶¨Îäî Ï∂îÍ∞Ä/ÏÇ≠Ï†úÏãú Ï†ÄÏû•Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏßÄ ÏïäÏïÑÎèÑ Î∞îÎ°ú Î∞òÏòÅÎê©ÎãàÎã§.</p>}
                    </div>
                }
                <b>ÏûëÏÑ±Ïûê</b>
                <FormInput size="lg" className="mb-3" placeholder="ÏûëÏÑ±Ïûê" value={author} onChange={e => { setAuthor(e.target.value) }} />
                <b>Ï†úÎ™©</b>
                <FormInput size="lg" className="mb-3" placeholder="Ï†úÎ™©" value={title} onChange={e => { setTitle(e.target.value) }} />
                <b>Î≥∏Î¨∏</b>
                <QuillEditor className="add-new-post__editor mb-1" value={contents} onChange={v => { setContents(v) }} />
                <div>
                    <b>Ï≤®Î∂ÄÌååÏùº</b><br />
                    {attachments ?
                        <>
                            {typeof (attachments) === 'string' ? <a target="_blank" rel="noopener noreferrer" href={attachments}>{attachments}</a> : attachments.name}
                            <button type="button" className="btn btn-danger" onClick={() => { setAttachments(null) }}>ÏÇ≠Ï†ú</button>
                        </> :
                        <FileDropzone fileProcessType="origin" onChange={files => { files.length > 0 ? setAttachments(files[0]) : setAttachments(null) }} />
                    }
                </div>
            </Form>
        </Modal >
    )
}